#!/usr/bin/env groovy

/*
 * This script takes the following parameters:
 *
 * Repos and branches
 *  - MBED_CRYPTO_REPO
 *  - MBED_CRYPTO_BRANCH
 *  - MBED_TLS_REPO
 *  - MBED_TLS_BRANCH
 *  - MBED_OS_REPO
 *  - MBED_OS_BRANCH
 *  - MBED_OS_TLS_EXAMPLES_REPO
 *  - MBED_OS_TLS_EXAMPLES_BRANCH
 *  - MBED_OS_CRYPTO_EXAMPLES_REPO
 *  - MBED_OS_CRYPTO_EXAMPLES_BRANCH
 *  - MBED_OS_ATECC608A_EXAMPLES_REPO
 *  - MBED_OS_ATECC608A_EXAMPLES_BRANCH
 *
 * Test options
 *  - RUN_BASIC_BUILD_TEST
 *  - RUN_ALL_SH
 *  - RUN_WINDOWS_TEST
 *  - TEST_MBED_OS_TLS_EXAMPLES
 *  - TEST_MBED_OS_CRYPTO_EXAMPLES
 *  - TEST_MBED_OS_ATECC608A_EXAMPLES
 *  - PLATFORMS_TO_TEST
 *
 * Other parameters
 *  - TEST_FAIL_EMAIL_ADDRESS - (only in nightly jobs)
 *  - TEST_PASS_EMAIL_ADDRESS - (only in nightly jobs)
 *
 * Environment variables:
 *  - GIT_CREDENTIALS_ID
 */

/* main job */
library identifier: 'mbedtls-test@master', retriever: legacySCM(scm)
environ.set_crypto_release_environment()

timestamps {
    try {
        stage('crypto-testing') {
            def jobs = gen_jobs.gen_release_jobs()

            common.run_release_jobs(
                "Mbed Crypto nightly tests",
                jobs,
                gen_jobs.failed_builds,
                gen_jobs.coverage_details
            )
        }
    } finally {
        analysis.analyze_results()
    }
}
